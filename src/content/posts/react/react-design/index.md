---
title: "React 设计原理导论"
published: 2025-05-12
description: ""
image: ""
tags: ["react"]
category: "前端入门"
draft: true
---

# 0 前言

本文适合具有 react 编码经验的读者，或者熟悉原生 js 的读者。

本文基于 react 18 版本，介绍 react 的设计思路。

本文是一个初步引导，更多更详细的内容，可以参阅书籍《React 设计原理（卡颂）》，也可以进一步阅读源码。

## 本文目标

- 1、了解 react 整体设计思路
- 2、了解主要模块的设计思路
- 3、编写高质量代码

最终读者能够获得对 react 整体流程的认知，以及后续自学的基础能力和研究方向。

# 1 正文

## 1.1 react 整体设计思路

### 1.1.1 简单的 jsx 代码 🌰

先看一段经典的计数器代码：

```js
import React, { useState } from "react";
const App = () => {
  const [count, setCount] = useState(0);
  return (
    <div>
      <button onClick={() => setCount(count + 1)}>Count: {count}</button>
    </div>
  );
};
```

显然，这会在页面上显示一个按钮，点击按钮后，数字会加 1。

这里我们需要注意到的代码功能：

- 组件模块的导入导出
- jsx 语法到 js 语法到转换
- 状态变量的定义与更新
- element 的生成、事件加载、dom 挂载、重新渲染

不必深究，有个印象即可，后文会进一步解释。

### 1.1.2 原生 js 代码 🌰

思考上面的计数器代码，如果用原生 js 代码实现，我们会怎么去实现？

随即我们能够想到，类似这样的代码：

```js
const renderButton = () => {
  let count = 0;
  const button = document.createElement("button");
  button.textContent = `Count: ${count}`;
  button.addEventListener("click", () => {
    count++;
    button.textContent = `Count: ${count}`;
  });
};

const buttonElement = renderButton();
// appendChild(buttonElement)
```

基本思路是这样的，在点击按钮后，修改按钮的 textContent，从而实现数字的变化。

但是这里存在一些问题：

- 1、业务逻辑和 dom 操作耦合在一起，无法复用。
- 2、随着组件的规模的增加，代码会变得非常复杂，难以维护。
- 3、组件间的状态管理和交互逻辑不易共享和复用。

显然，这样的代码在实际的工程项目中，是不可取的。

### 1.1.3 react 的工作

我们做这样的实验（可以不用实际编码）：

- 1、基于 create-react-app 构建一个简单的 react 项目。

- 2、使用 1.1.1 中的计数器代码，引入到页面中。

- 3、编译运行。

- 4、点击按钮，页面中数字变化。

在这个过程中，react 帮我们做了什么？

这里需要分两种情况来讨论：

- 运行之前 —— 编码、打包阶段
- 运行时阶段

#### 1.1.3.1 运行之前

在运行之前，我们按照 react 的编码规范，完成 jsx 代码的编写（可以是 cra 工具生成的代码框架，也可以是手动修改的代码）。

这时，**react 本身负责设计 JSX 规范**。

接下来，在打包流程中，使用 Babel 工具将 JSX 代码转换为 JavaScript 代码，使得其能够在浏览器中运行。

例如：

```js
// 原始 JSX
<button onClick={() => setCount(count + 1)}>Click me</button>;

// Babel 编译后（简化）
React.createElement(
  "button",
  { onClick: () => setCount(count + 1) },
  "Click me"
);
```

这个转换过程中，由 **react 负责定义规则**，并**提供相关 API**，例如 React.createElement 。

#### 1.1.3.2 运行时阶段

简单来说，编译后的 js 代码可以直接运行在浏览器的 js 引擎中。

这些 js 代码，有一部分就是 react 的核心模块，他们会被加载到内存里面，在运行时发挥重要作用。

这些核心模块的本质，就是一组 js 函数和对象。

他们在两个时期发挥重要作用：1、代码初始化时；2、状态更新时。

**在初始化时，负责建立组件层级体系，创建页面；在状态更新时，负责响应交互，更新 UI**。

我们常说的 react 设计原理，就是指这两个时期的机制设计。

其中包括了我们常见的一些概念设计：

- fiber 架构
- hooks 系统
- 虚拟 dom
- diff 算法
- 合成事件
- 批量更新
- 上下文系统

这些概念设计，在后续章节中会简要介绍。

### 1.1.4 简单总结

react 的设计原理，就是指它在运行时是怎么发挥作用的。

我们了解了这些作用后，就能完全理解 1.1.1 中的计数器代码是怎么工作的了。

## 1.2 react 主要模板

js 中，一个函数被加载到内存中的调用栈中，然后执行。它一般会做两件事：1、进行一些运算；2、申请一些内存空间。

在 react 的初始化阶段，也相当于执行了一个函数，函数中同样会做两件事：1、进行一些运算；2、申请一些内存空间。

这些内存空间中，加载了它的各种模块，也就是一些函数和变量，便于后续调用。

在 react 的状态更新阶段，就是根据情况调用了某些模块的函数。

### 1.2.1 模板执行过程

react 中模块会在初始化阶段执行，也会在触发更新时执行。

本文只介绍触发更新时的执行过程，因为这个过程更容易理解。

举个例子：

- 用户点击按钮之后，触发事件 (js 原生功能：事件冒泡机制)
- 触发 onClick 回调函数 (react 功能：自定义的事件加载机制)
- 函数执行 (js 原生功能：调用栈逻辑)
- 函数执行到 setCount() 函数，触发调度任务 (react 功能：调度中心处理)

到这里其实点击事件就结束了，后续是 react 的调度中心的工作了。

调度中心再处理各种任务，给到渲染中心，确定 UI 更新内容，最后完成 UI 更新。

这里的通信机制，是 react 的设计，基本思路就是发布订阅模式实现的。
